* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jan, 11. 2022. JOBID=4188193050
* INPUT FILE FOR EQUILIBRATION OF SOLVATED GLOBULAR PROTEIN
* 

DIMENS CHSIZE 500000 MAXRES 300000

! Read topology and parameter files
stream toppar.str

! Read PSF
open read unit 10 card name step3_pbcsetup.psf
read psf  unit 10 card

!Read Coordinate
open read unit 10 card name step3_pbcsetup.crd
read coor unit 10 card


open read card unit 10 name CO.crd
read sequence coor card unit 10 resid
generate CO setup warn first none last none

open read unit 10 card name CO.crd
read coor unit 10 card resid


!
! Setup PBC (Periodic Boundary Condition)
!

stream step3_pbcsetup.str

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD

!Image centering by residue
calc ahalf = @A / 2.0
calc bhalf = @B / 2.0
calc chalf = @C / 2.0


IMAGE BYRESID XCEN @ahalf YCEN @bhalf ZCEN @chalf sele resname TIP3 end
IMAGE BYSEG   XCEN @ahalf YCEN @bhalf ZCEN @chalf sele .not. resname TIP3 end


!Image centering by residue
!IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele resname TIP3 end
!IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele segid IONS end

!
! Nonbonded Options
!

!nbonds atom vatom vfswitch bycb -
!       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 cutim 16.0 -
!       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0 -
!       ewald pmew fftx @fftx ffty @ffty fftz @fftz  kappa .34 spline order 6

nbonds atom vatom vfswitch bycb -
       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 cutim 16.0

!
! Fix Environment
!

energy

!cons fix sele all .and. .not. resid CO end
cons fix sele segid PROA .or. segid SOLV .or. segid IONS .or. segid HETA end

energy


!
!use positional restraints for equilibration
![you can change the force constant and run longer equilibration (at least 100-200 ps)]
!

mini SD   nstep 50 nprint 5
mini ABNR nstep 50 nprint 5

open write unit 10 card name step4_mini.pdb
write coor unit 10 pdb




!
! NVT dynamics,
! you can change
! nstep  : number of MD steps
! nprint : print-out frequency
! NOTE:
! The integration time step (timestep) is set to 1 fs only for equilibration
! to avoid any unstable dynamics and thus abnormal termination.
! However, it might be possible to increase it to 2 fs in most applications.
!

set nstep =  40000 
set temp = 303.15

shake bonh param fast sele .not. segid H2 end

open write unit 12 card name step4_equilibration.res
open write unit 13 file name heat.dcd      


DYNA VVER start timestep 0.001 nstep @nstep -
     nprint 1000 iprfrq 1000 ntrfrq 1000 -
     iunread -1 iunwri 12 iuncrd 13 iunvel -1 kunit -1 -
     nsavc 250 nsavv 0 -
     nose rstn tref @temp qref 50 ncyc 10 firstt @temp

open write unit 10 card name step4_equilibration.pdb
write coor unit 10 pdb

open write unit 10 card name step4_equilibration.crd
write coor unit 10 card
close unit 10

!
! NPT dynamics:
! you can change
! nstep  : number of MD steps
! nprint : print-out frequency
! nsavc  : the trajectory saving frequency
!

! estimate Pmass from SYSmass (total system mass)
! [there could be problems with exreme values, such as  Pmass << SYSmass or Pmass >> SYSmass

scalar mass stat
calc Pmass = int ( ?stot  /  50.0 )

set nstep = 40000
set temp = 50

shake bonh param fast

open read  unit 11 card name step4_equilibration.res
open write unit 12 card name equi.res
open write unit 13 file name equi.dcd

DYNA CPT leap restart time 0.001 nstep @nstep -
     nprint 1000 iprfrq 1000 ntrfrq 500 -
     iunread 11 iunwri 12 iuncrd 13 iunvel -1 kunit -1 -
     nsavc 250 nsavv 0 -
     PCONSTANT pref   1.0  pmass @Pmass  pgamma   20.0 -
     HOOVER    reft @temp  tmass 2000.0  tbath   @temp  firstt @temp


open write unit 10 card name equi.pdb
write coor unit 10 pdb
close unit 10

open write unit 10 card name equi.crd
write coor unit 10 card
close unit 10


stop
